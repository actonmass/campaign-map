<html>

<head>
  <title>Representative support for Act On Mass Transparency Campaign</title>
  <base target="_blank">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />

  <style>
    :root {
      --join-color: rgba(0, 0, 0, 0.2);
      --join-color--active: rgba(0, 0, 0, 0.4);
      --vote-color: rgba(90, 186, 161, 0.6);
      --vote-color--active: rgba(90, 186, 161, 0.9);
    }

    body {
      margin: 0;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    a {
      color: #00529A !important;
    }

    .legend {
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding: 0 0.5rem;
    }

    .legend__item {
      display: flex;
      align-items: center;
      margin: 0.5rem 0;
    }

    .legend__item::before {
      background: var(--join-color);
      border-radius: 2px;
      content: '';
      display: block;
      margin-right: 0.5rem;
      height: 1rem;
      width: 1rem;
    }

    .legend__item--vote::before {
      background: var(--vote-color);
    }

    .district {
      fill: var(--join-color);
      fill-opacity: 1;
      stroke: var(--join-color);
      stroke-width: 1;
    }

    .district:hover {
      stroke-width: 4;
    }

    .district--active {
      fill: var(--join-color--active);
    }

    .district--vote {
      fill: var(--vote-color);
    }

    .district--vote.district--active {
      fill: var(--vote-color--active);
    }

    .leaflet-control-search .search-input {
      outline: none;
    }

    .leaflet-control-search .search-tooltip {
      margin: 2px 0 0;
      width: 100%;
      border-radius: 4px;
    }

    .leaflet-control-search .search-tip {
      margin: 0;
      border-radius: 0;
    }

  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-providers@1.11.0/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

  <script>
    /* global L, Papa */
    Promise.all([
      fetch('https://docs.google.com/spreadsheets/d/1iY5wzVUpAKRHBF-vrwyUBz9_wV93FVqu4MW5viPSkas/export?gid=395703872&format=csv')
        .then((response) => response.text())
        .then((csv) => {
          const parsed = Papa.parse(csv, { header: true, dynamicTyping: true });
          return Promise.resolve(parsed.data);
        }),
      fetch('https://raw.githubusercontent.com/bhrutledge/ma-legislature/main/dist/ma_house.geojson')
        .then((response) => response.json()),
    ])
      .then(([supporters, houseFeatures]) => {
        const supportersByDistrict = supporters.reduce((acc, cur) => {
          acc[cur.district] = cur;
          return acc;
        }, {});

        function repProperties(feature) {
          const supporter = supportersByDistrict[feature.properties.district];

          // Supporter info from Sheet may be incomplete, so only prefer it to
          // replace outgoing incumbents
          return supporter && supporter.elect
            ? { ...feature.properties, ...supporter } : { ...supporter, ...feature.properties };
        }

        const districtLegend = () => `
          <div class="legend__item legend__item--vote">
            Committed to Vote
          </div>
          <div class="legend__item legend__item--join">
            Join District Team
          </div>
        `;

        const districtStyle = (rep) => ({
          className: `district district--${rep.vote ? 'vote' : 'join'}`,
        });

        const callToAction = (rep, text) => `
          <a href="https://actonmass.org/the-campaign/?your_state_representative=${rep.first_name} ${rep.last_name}"
            target="_parent"
          >
            ${text}
          </a>
        `;

        const districtPopup = (rep) => `
          <p>
            <strong>${rep.first_name} ${rep.last_name}</strong>
            ${rep.url ? `(<a href="${rep.url}">contact</a>)` : ''}
            <br />${rep.party} ${rep.elect ? '(Elect)' : ''}
            <br />${rep.district}
          </p>

          <p>
            ${rep.vote ? `
              <strong>Committed to Vote</strong>
              ${rep.vote_note ? `<br />(${rep.vote_note})` : ''}
              <br />${callToAction(rep, 'Join the Campaign')}
            ` : `
              ${callToAction(rep, '<strong>Join District Team</strong>')}
            `}
          </p>
        `;

        const houseLayer = L.geoJson(houseFeatures, {
          style: (feature) => districtStyle(repProperties(feature)),
          onEachFeature: (feature, layer) => {
            layer.bindPopup(districtPopup(repProperties(feature)));

            function setActive(active = false) {
              layer.getElement().classList.toggle('district--active', active);
            }
            layer.on('popupopen', () => setActive(true));
            layer.on('popupclose', () => setActive(false));
          },
        });

        const legendControl = L.control({ position: 'topright' });
        legendControl.onAdd = () => {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = districtLegend();
          return div;
        };

        const searchControl = new L.Control.Search({
          layer: houseLayer,
          propertyName: 'district',
          initial: false,
          marker: false,
          textPlaceholder: 'Search districts',
          moveToLocation(latlng, title, map) {
            map.fitBounds(latlng.layer.getBounds());
            latlng.layer.openPopup();
          },
        });
    
        L.map('map')
          .addLayer(L.tileLayer.provider('CartoDB.Positron'))
          .addLayer(houseLayer)
          .addControl(legendControl)
          .addControl(searchControl)
          .fitBounds(houseLayer.getBounds());
      });
  </script>
</body>

</html>
